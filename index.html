<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>College Football Ballot</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    select { margin: 5px 0; width: 300px; }
    button { margin-top: 10px; padding: 8px 16px; }
  </style>
</head>
<body>
  <h1>Submit Your Top 25 Ballot</h1>

  <!-- Login / Signup Form -->
  <div id="auth">
    <h2>Login or Sign Up</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <br>
    <button type="button" onclick="login()">Login</button>
    <button type="button" onclick="signup()">Sign Up</button>
  </div>

  <!-- Ballot Form -->
  <form id="ballotForm" style="display:none;">
    <h2>Your Ballot</h2>
    <ol id="ballotList"></ol>
    <button type="submit">Submit Ballot</button>
  </form>

  <script>
    // Replace with your Supabase project credentials
    const SUPABASE_URL = "https://dvtlrfiwoggyqhdadzqp.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2dGxyZml3b2dneXFoZGFkenFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0ODQ4OTksImV4cCI6MjA3MzA2MDg5OX0.cDORUcuFBkEIDrL54F6ZEo74NIrsQvCAeDD9NDOficY"; // must be anon key
    const REDIRECT_URL = "https://showtimecfb.github.io/creatorsballot2/"; // replace with your GitHub Pages URL
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const teams = [
      "Alabama","Arkansas","Auburn","Baylor","Boise State",
      "BYU","Cincinnati","Clemson","Colorado","Duke",
      "Florida","Florida State","Fresno State","Georgia","Georgia Tech",
      "Houston","Illinois","Indiana","Iowa","Iowa State",
      "Kansas","Kansas State","Kentucky","Liberty","Louisville",
      "LSU","Marshall","Maryland","Memphis","Miami",
      "Michigan","Michigan State","Minnesota","Mississippi State","Missouri",
      "Navy","Nebraska","North Carolina","NC State","Northwestern",
      "Notre Dame","Ohio State","Oklahoma","Oklahoma State","Ole Miss",
      "Oregon","Oregon State","Penn State","Pittsburgh","Purdue",
      "Rice","Rutgers","San Diego State","SMU","South Carolina",
      "Stanford","Syracuse","TCU","Tennessee","Texas",
      "Texas A&M","Texas Tech","Toledo","Troy","Tulane",
      "UAB","UCF","UCLA","USC","Utah",
      "Utah State","Vanderbilt","Virginia","Virginia Tech","Wake Forest",
      "Washington","Washington State","West Virginia","Wisconsin","Wyoming"
    ];

    let currentUser = null;

    function buildBallotForm() {
      const list = document.getElementById("ballotList");
      list.innerHTML = "";
      for (let i = 1; i <= 25; i++) {
        const li = document.createElement("li");
        const select = document.createElement("select");
        teams.forEach(team => {
          const opt = document.createElement("option");
          opt.value = team;
          opt.textContent = team;
          select.appendChild(opt);
        });
        select.name = "team" + i;
        li.appendChild(select);
        list.appendChild(li);
      }
    }

    function afterLogin() {
      document.getElementById("auth").style.display = "none";
      document.getElementById("ballotForm").style.display = "block";
      buildBallotForm();
    }

    // Signup function with redirectTo for GitHub Pages
    async function signup() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      const { data, error } = await supabase.auth.signUp({
        email,
        password,
        options: { emailRedirectTo: REDIRECT_URL }
      });

      if (error) return alert("Signup error: " + error.message);
      alert("Signup successful! Check your email to confirm your account before logging in.");
    }

    // Login function with redirectTo for GitHub Pages
    async function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password,
        options: { redirectTo: REDIRECT_URL }
      });

      if (error) return alert("Login error: " + error.message);

      // Get session user
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        currentUser = session.user;
        afterLogin();
      } else {
        alert("Login successful but no session found. Check your redirect URL and email confirmation.");
      }
    }

    // Submit ballot
    document.getElementById("ballotForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return alert("Please log in first.");

      const selects = document.querySelectorAll("#ballotList select");
      const picks = [];
      selects.forEach((sel, idx) => {
        picks.push({ rank: idx + 1, team: sel.value });
      });

      const uniqueTeams = new Set(picks.map(p => p.team));
      if (uniqueTeams.size < 25) return alert("Duplicate teams detected. Fix your ballot.");

      const { error } = await supabase.from("ballots").upsert({
        user_id: currentUser.id,
        ballot: picks
      }, { onConflict: "user_id" });

      if (error) {
        alert("Error submitting ballot: " + error.message);
      } else {
        alert("Ballot submitted successfully!");
      }
    });
  </script>
</body>
</html>
